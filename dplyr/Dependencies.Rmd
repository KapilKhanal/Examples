---
title: "Dependencies"
author: "Win-Vector LLC"
date: "11/29/2017"
output: github_document
---

Set up our example.

```{r setup}
packageVersion("dplyr")

my_db <- DBI::dbConnect(RSQLite::SQLite(),
                        ":memory:")
d <- dplyr::copy_to(my_db, 
                    data.frame(val = c(0, 5),
                               a_1 = "UNINITIALIZED",
                               a_2 = "UNINITIALIZED"), 
                    'd')
```

Run, and find a non-signalling data-mangle issue.  For our example we
are assigning paired columns `a_1` and `a_2` to complementary treatment and 
control groups. In this case we do this by simulating an if/else conditional
assignment using `ifelse(,,)` value operators (we could have done this different
ways, but this is one possible solution that could occur in practice).

```{r badresult}
# all values in a_1 and a_2 should
# be "treatment" or "control" after
# the following statement.  
# That is not the case.
dplyr::mutate(d,
              cond = val>2,
              a_1 = ifelse( cond, 
                            'treatment', 
                            a_1),
              a_2 = ifelse( cond, 
                            'control', 
                            a_2),
              a_1 = ifelse( !( cond ), 
                            'control', 
                            a_1),
              a_2 = ifelse( !( cond ), 
                            'treatment', 
                            a_2))
```

Obviously *this* example could have been written as below, but the issue is code
similar to the above could part of a larger more complicated analysis. And one still
wants correct results from correct code (even if it is not the shortest or most
optimal code).

```{r meth2}
dplyr::mutate(d,
              cond = val>2,
              a_1 = ifelse( cond, 
                            'treatment', 
                            'control'),
              a_2 = ifelse( cond, 
                            'control', 
                            'treatment'))
```

[`seplyr`](https://winvector.github.io/seplyr/) work-around: break up the steps into safe blocks ([announcement](http://www.win-vector.com/blog/2017/11/win-vector-llc-announces-new-big-data-in-r-tools/)).

```{r goodresult}
library("seplyr")

plan <- if_else_device(
              testexpr = "val>2",
              thenexprs = c("a_1" := "'treatment'",
                            "a_2" := "'control'"),
              elseexprs = c("a_1" := "'control'",
                            "a_2" := "'treatment'")) %.>% 
  partition_mutate_se(.)

print(plan)

d %.>% 
  mutate_seb(., plan) %.>% 
  select_se(., grepdf("^ifebtest_", ., invert = TRUE))
```

