ggplot2
================

Look at size of the ggplot2 `VECTOR_ELT()` issue.

[CRAN Package Check Results for Package ggplot2](https://cran.r-project.org/web/checks/check_results_ggplot2.html)

<p>
Last updated on 2019-03-31 21:47:09 CEST.
</p>
<table border="1" summary="CRAN check results for package ggplot2">
<tr>
<th>
Flavor
</th>
<th>
Version
</th>
<th>
T<sub>install</sub>
</th>
<th>
T<sub>check</sub>
</th>
<th>
T<sub>total</sub>
</th>
<th>
Status
</th>
<th>
Flags
</th>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-devel-linux-x86_64-debian-clang"> r-devel-linux-x86\_64-debian-clang </a>
</td>
<td>
3.1.0
</td>
<td class="r">
20.49
</td>
<td class="r">
175.94
</td>
<td class="r">
196.43
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-devel-linux-x86_64-debian-clang/ggplot2-00check.html"><span class="check_ko">ERROR</span></a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-devel-linux-x86_64-debian-gcc"> r-devel-linux-x86\_64-debian-gcc </a>
</td>
<td>
3.1.0
</td>
<td class="r">
14.63
</td>
<td class="r">
239.16
</td>
<td class="r">
253.79
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-devel-linux-x86_64-debian-gcc/ggplot2-00check.html"><span class="check_ok">OK</span></a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-devel-linux-x86_64-fedora-clang"> r-devel-linux-x86\_64-fedora-clang </a>
</td>
<td>
3.1.0
</td>
<td class="r">
</td>
<td class="r">
</td>
<td class="r">
392.78
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-devel-linux-x86_64-fedora-clang/ggplot2-00check.html">NOTE</a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-devel-linux-x86_64-fedora-gcc"> r-devel-linux-x86\_64-fedora-gcc </a>
</td>
<td>
3.1.0
</td>
<td class="r">
</td>
<td class="r">
</td>
<td class="r">
379.50
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-devel-linux-x86_64-fedora-gcc/ggplot2-00check.html">NOTE</a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-devel-windows-ix86_x86_64"> r-devel-windows-ix86+x86\_64 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
46.00
</td>
<td class="r">
421.00
</td>
<td class="r">
467.00
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-devel-windows-ix86+x86_64/ggplot2-00check.html"><span class="check_ok">OK</span></a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-patched-linux-x86_64"> r-patched-linux-x86\_64 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
18.84
</td>
<td class="r">
129.45
</td>
<td class="r">
148.29
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-patched-linux-x86_64/ggplot2-00check.html"><span class="check_ko">ERROR</span></a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-patched-solaris-x86"> r-patched-solaris-x86 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
</td>
<td class="r">
</td>
<td class="r">
524.10
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-patched-solaris-x86/ggplot2-00check.html">NOTE</a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-release-linux-x86_64"> r-release-linux-x86\_64 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
13.63
</td>
<td class="r">
309.95
</td>
<td class="r">
323.58
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-release-linux-x86_64/ggplot2-00check.html"><span class="check_ok">OK</span></a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-release-windows-ix86_x86_64"> r-release-windows-ix86+x86\_64 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
23.00
</td>
<td class="r">
311.00
</td>
<td class="r">
334.00
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-release-windows-ix86+x86_64/ggplot2-00check.html"><span class="check_ko">WARN</span></a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-release-osx-x86_64"> r-release-osx-x86\_64 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
</td>
<td class="r">
</td>
<td class="r">
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-release-osx-x86_64/ggplot2-00check.html">NOTE</a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-oldrel-windows-ix86_x86_64"> r-oldrel-windows-ix86+x86\_64 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
15.00
</td>
<td class="r">
498.00
</td>
<td class="r">
513.00
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-oldrel-windows-ix86+x86_64/ggplot2-00check.html"><span class="check_ko">WARN</span></a>
</td>
<td>
</td>
</tr>
<tr>
<td>
<a href="check_flavors.html#r-oldrel-osx-x86_64"> r-oldrel-osx-x86\_64 </a>
</td>
<td>
3.1.0
</td>
<td class="r">
</td>
<td class="r">
</td>
<td class="r">
</td>
<td>
<a href="https://www.R-project.org/nosvn/R.check/r-oldrel-osx-x86_64/ggplot2-00check.html">NOTE</a>
</td>
<td>
</td>
</tr>
</table>
r-devel-linux-x86\_64-debian-clang

    > geom_jitter() +
     + scale_x_discrete(expand = expand_scale(add = .6)) +
     + scale_y_continuous(expand = expand_scale(mult = .05))
     Error: Cannot add ggproto objects together. Did you forget to add this object to a ggplot object?
     Execution halted

r-patched-linux-x86\_64

    > ggplot(mpg, aes(displ, hwy)) + geom_point()
      Error in grid.Call.graphics(C_setviewport, vp, TRUE) : 
        VECTOR_ELT() can only be applied to a 'list', not a 'double'
      Calls: <Anonymous> ... lapply -> FUN -> push.vp.viewport -> grid.Call.graphics

``` r
library("rqdatatable")
```

    ## Loading required package: rquery

``` r
# # load package facts
# cran <- tools::CRAN_package_db()
# cr <- tools::CRAN_check_results()
# saveRDS(list(cran = cran, cr = cr), "cran_facts_2019_03_31.RDS")
lst <- readRDS("cran_facts_2019_03_31.RDS")
cran <- lst$cran
cr <- lst$cr
```

``` r
target_pkg <- "ggplot2"
usage_types <- c("Depends", "Imports", "Suggests", "LinkingTo")
```

``` r
package_summary <- cr %.>%
  select_rows(.,
              !is.na(Status)) %.>%
  extend(., 
         one = 1) %.>%
  project(.,
          groupby = c("Package", "Status"),
          count = sum(one)) %.>%
  cdata::pivot_to_rowrecs(., 
                          columnToTakeKeysFrom = "Status",
                          columnToTakeValuesFrom = "count",
                          rowKeyColumns = "Package") %.>%
  extend(.,
         OK = ifelse(is.na(OK), 0, OK),
         NOTE = ifelse(is.na(NOTE), 0, NOTE),
         WARN = ifelse(is.na(WARN), 0, WARN),
         ERROR = ifelse(is.na(ERROR), 0, ERROR),
         FAIL = ifelse(is.na(FAIL), 0, FAIL)) %.>%
  extend(.,
         has_problem = (WARN + ERROR + FAIL)>0)
  
package_summary %.>% 
  head(.) %.>%
  knitr::kable(.)
```

| Package     |   OK|  NOTE|  WARN|  ERROR|  FAIL| has\_problem |
|:------------|----:|-----:|-----:|------:|-----:|:-------------|
| A3          |   12|     0|     0|      0|     0| FALSE        |
| abbyyR      |   12|     0|     0|      0|     0| FALSE        |
| abc         |    0|    12|     0|      0|     0| FALSE        |
| abc.data    |   12|     0|     0|      0|     0| FALSE        |
| ABC.RAP     |   11|     0|     1|      0|     0| TRUE         |
| ABCanalysis |   12|     0|     0|      0|     0| FALSE        |

``` r
# convert comma separated list into
# sequence of non-core package names
parse_lists <- function(strs) {
  strs[is.na(strs)] <- ""
  strs <- gsub("[(][^)]*[)]", "", strs)
  strs <- gsub("\\s+", "", strs)
  strs <- strsplit(strs, ",", fixed=TRUE)
  strs <- lapply(
    strs,
    function(si) {
      setdiff(si, c("", "R", 
                    "base", "compiler", "datasets", 
                    "graphics", "grDevices", "grid",
                    "methods", "parallel", "splines", 
                    "stats", "stats4", "tcltk", "tools",
                    "translations", "utils"))
    })
  strs
}

# collect the columns we want
# collect the columns we want
d <- data.frame(
  Package = cran$Package,
  stringsAsFactors = FALSE)
for(use_type in c("Depends", "Imports", "Suggests", "LinkingTo")) {
  d[[use_type]] <- parse_lists(cran[[use_type]])
  d[[paste0("n_", use_type)]] <- vapply(d[[use_type]], length, numeric(1))
  use_str <- paste(use_type, target_pkg, sep = "_")
  d[[use_str]] <- vapply(d[[use_type]], 
                            function(di) {
                              target_pkg %in% di
                            }, logical(1))
  print(use_str)
  print(table(d[[use_str]]))
}
```

    ## [1] "Depends_ggplot2"
    ## 
    ## FALSE  TRUE 
    ## 13698   304 
    ## [1] "Imports_ggplot2"
    ## 
    ## FALSE  TRUE 
    ## 12765  1237 
    ## [1] "Suggests_ggplot2"
    ## 
    ## FALSE  TRUE 
    ## 13405   597 
    ## [1] "LinkingTo_ggplot2"
    ## 
    ## FALSE 
    ## 14002

``` r
per_pkg_uses <- paste(usage_types, target_pkg, sep = "_")

d <- d[, c("Package", "n_Depends", "n_Imports", "n_Suggests",
           per_pkg_uses)]

d %.>%
  extend(., one = 1) %.>%
  project(., 
          groupby = per_pkg_uses,
          count = sum(one)) %.>% 
  orderby(., per_pkg_uses) %.>%
  knitr::kable(.)
```

| Depends\_ggplot2 | Imports\_ggplot2 | Suggests\_ggplot2 | LinkingTo\_ggplot2 |  count|
|:-----------------|:-----------------|:------------------|:-------------------|------:|
| FALSE            | FALSE            | FALSE             | FALSE              |  11865|
| FALSE            | FALSE            | TRUE              | FALSE              |    596|
| FALSE            | TRUE             | FALSE             | FALSE              |   1237|
| TRUE             | FALSE            | FALSE             | FALSE              |    303|
| TRUE             | FALSE            | TRUE              | FALSE              |      1|

``` r
# map check status into our data
nrow(d)
```

    ## [1] 14002

``` r
d <- natural_join(d, package_summary, 
                  by = "Package", 
                  jointype = "INNER")
(npackages <- nrow(d))
```

    ## [1] 14001

``` r
uses_package <- paste("uses", target_pkg, sep = "_")
d %.>%
  extend_se(., 
            list(qe(one := 1),
                 paste(uses_package, " := (", paste(per_pkg_uses, collapse = " + "), ")>0"))) %.>%
  project(., 
          groupby = c(uses_package, "has_problem"),
          count = sum(one)) %.>% 
  extend(., 
         fraction = count/sum(count)) %.>%
  orderby(., c(uses_package, "has_problem")) %.>%
  knitr::kable(.)
```

| uses\_ggplot2 | has\_problem |  count|   fraction|
|:--------------|:-------------|------:|----------:|
| FALSE         | FALSE        |  10234|  0.7309478|
| FALSE         | TRUE         |   1630|  0.1164203|
| TRUE          | FALSE        |    444|  0.0317120|
| TRUE          | TRUE         |   1693|  0.1209199|

``` r
f <- wrapr::mk_formula("has_problem", per_pkg_uses)
model <- glm(f, 
             data = d, 
             family = binomial)
summary(model)
```

    ## 
    ## Call:
    ## glm(formula = f, family = binomial, data = d)
    ## 
    ## Deviance Residuals: 
    ##     Min       1Q   Median       3Q      Max  
    ## -1.9090  -0.5437  -0.5437  -0.5437   1.9925  
    ## 
    ## Coefficients: (1 not defined because of singularities)
    ##                       Estimate Std. Error z value Pr(>|z|)    
    ## (Intercept)           -1.83714    0.02667  -68.89   <2e-16 ***
    ## Depends_ggplot2TRUE    3.48293    0.15828   22.00   <2e-16 ***
    ## Imports_ggplot2TRUE    3.28731    0.07723   42.56   <2e-16 ***
    ## Suggests_ggplot2TRUE   2.83971    0.09620   29.52   <2e-16 ***
    ## LinkingTo_ggplot2TRUE       NA         NA      NA       NA    
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## (Dispersion parameter for binomial family taken to be 1)
    ## 
    ##     Null deviance: 15345  on 14000  degrees of freedom
    ## Residual deviance: 11660  on 13997  degrees of freedom
    ## AIC: 11668
    ## 
    ## Number of Fisher Scoring iterations: 4
